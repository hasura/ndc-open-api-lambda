<% const { apiRoutes, importList, baseUrl, headerMap } = it; _%>

import { <%~ it.importList.join(', ') %> } from './api';
import * as hasuraSdk from "@hasura/ndc-lambda-sdk"

<%-
const hasParams = (route) => {
  return (route.allParams && route.allParams.length > 0)
}

const getParameterAsFunctionParam = (param) => { // parameter accepted by the funciton in function.ts
  if (param.required) {
    return `${param.name}: ${param.tsType} ,`
  } else {
    return `${param.name}?: ${param.tsType} ,`
  }
}

const hasHeaders = (headers) => {
  return (headers && headers.size > 0)
}
-%>

const api = new Api({
  baseUrl: '<%~ baseUrl %>',
<% if (hasHeaders(headerMap)) { %>
  baseApiParams: {
    headers: {
<% for (const [key, value] of headerMap) { %>
      "<%~key%>": "<%~value%>",
<% } %>
    }
  }
<% } %>
});

<%- for (let req of apiRoutes) { %>

/**
 * <%~ req.description %>

 * @request <%~ req.type %> :<%~ req.route %>

<% if (req.shouldAllowRelaxedTypes) { %>
 * @allowrelaxedtypes
<% } %>
<% if (req.isQuery) { %>
 * @readonly
<% } %>
 */
  <% if (!hasParams(req)) { %>
    export async function <%~ req.functionName %> ():
  <% } else { %>
    export async function <%~ req.functionName %> (
      <% if (req.parsedQueryParams) { %>
        <%~ req.parsedQueryParams._rendered %>
      <% } %>

      <% for (parameter of req.allParams) { %>
        <% if (parameter.paramType !== 'query') { %>
          /** <%~parameter.description %> */
          <%~ getParameterAsFunctionParam(parameter) %>
          
        <% } %>
      <% } %>
):
<%- } -%>
 Promise
<%_ if (req.shouldWrapReturnResultInJSON) { -%>
<hasuraSdk.JSONValue>
<%_ } else { -%>
<<%~ req.successType-%>>
<%- } -%>
 {

<%- if (!hasParams(req)) { %>
  const result = await api.<%~ req.namespace %>.<%~ req.apiFunction %>({});
<% } else { %>
  const result = await api.<%~ req.namespace %>.<%~ req.apiFunction %>({
<% if (req.parsedQueryParams) { %>
  <%~req.parsedQueryParams.name%>: <%~req.parsedQueryParams.name%>,
<% } %>

<%- if (req.allParams && req.allParams.length > 0) { %>
    <%_ for (const q of req.allParams) { %>
      <%_ if (q.paramType !== 'query') { -%>
    <%~q.name%>: <%~q.name%>,
<%    }
    }
  } %>
  });
<% } %>
<% if (req.successAndErrorResponseIsVoid) { %>
  return new hasuraSdk.JSONValue(result);
}
<% } else if (req.successResponseIsVoid) { %>
  if (result.error) {
    throw (result.error)
  } else {
    return new hasuraSdk.JSONValue(result.data);
  }
}
<% } else { %>
  if (result.data) {
    return <% if (req.shouldWrapReturnResultInJSON) { _%>
      new hasuraSdk.JSONValue(result.data);
<%   } else { _%>
      result.data
<%   } %>
  } else {
    throw (result.error)
  }
}
<% } %>
<% } %>
